{% extends 'layout.html' %}
{% block script %}
  var Request = new XMLHttpRequest();
  var flightPath;
  var currentPosition;
  function initialize() {
    var mapOptions = {
    zoom: 6,
    center: new google.maps.LatLng(36.807113, -79.190529)
    }
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    getPath();
    preloader();
    setInterval(addPointLoop, 15000)

    function getPath() {
        console.log('getPath');
        Request.onreadystatechange = addPath;
        Request.open('GET', '{{ url_for('get_coords') }}?all=True');
        Request.send();
    }

    function addPath() {
      if (Request.readyState == 4) {
        var flightPathCoordinates = [];
        var coords = JSON.parse(Request.responseText)
        for (a=0; a<coords.coordinates.length; a++) {
          flightPathCoordinates.push(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
          if (coords.coordinates[a].noteworthy != null) {
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude),
                map: map,
                title: coords.coordinates[a].noteworthy
            })
          }
        }
        flightPath = new google.maps.Polyline({
          path: flightPathCoordinates,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        })
        last = coords.coordinates.length - 1
        currentPosition = new google.maps.Marker({
            position: new google.maps.LatLng(coords.coordinates[last].latitude, coords.coordinates[last].longitude),
            map: map,
            title: "Current Position"
        });
        flightPath.setMap(map)
      }
    }
    function addPointLoop() {
      console.log('LOOPING');
      Request.onreadystatechange = addPoint;
      Request.open('GET', '{{ url_for('get_coords') }}');
      Request.send();
    }

    function addPoint() {
      if (Request.readyState == 4) {
        var path = flightPath.getPath();
        var coords = JSON.parse(Request.responseText);
        for (a=0; a<coords.coordinates.length; a++) {
          path.push(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
          if (coords.coordinates[a].noteworthy != null) {
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude),
                map: map,
                title: coords.coordinates[a].noteworthy
            })
          }
          currentPosition.setPosition(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
          map.panTo(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
        }
      }
    }

    function preloader(){
      document.getElementById("loading").style.display = "none";
      document.getElementById("content").style.display = "block";
    }
  }
  google.maps.event.addDomListener(window, 'load', initialize);
{% endblock %}
{% block body %}
<p>See below for live tracking the day of the launch</p>
    <div id="map-canvas" style="height:500px; width:600px; z:index:-1; margin: 0 auto;"></div>
	<div style="height:500px; width:600px; z:index:-1; margin: 0 auto;">
	<script type="text/javascript">
	he_track = "N4CAP-1"; // track this callsign
	</script>
	<script type="text/javascript" src="http://aprs.fi/js/embed.js">
	</script>
	</div>

    <div id="awidget"></div>
<script type="text/javascript" src="//d3ra5e5xmvzawh.cloudfront.net/live-widget/2.0/spot-main-min.js"></script>
<script type="text/javascript">
	$(function() {
		$('#widget').spotLiveWidget({
			feedId: '<SHARE_PAGE_FEED_ID>',
			mapType: 'HYBRID'
		});

	});
</script>

{% endblock %}