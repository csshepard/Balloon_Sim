{% extends 'layout.html' %}
{% block script %}
  var Request = new XMLHttpRequest();
  var flightPath;
  function initialize() {
    var mapOptions = {
    zoom: 6,
    center: new google.maps.LatLng(36.807113, -79.190529)
    }
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    getPath();
    preloader();
    setInterval(addPointLoop, 15000)

    function getPath() {
        console.log('getPath');
        Request.onreadystatechange = addPath;
        Request.open('GET', '{{ url_for('get_coords') }}?all=True');
        Request.send();
    }

    function addPath() {
      if (Request.readyState == 4) {
        var flightPathCoordinates = [];
        var coords = JSON.parse(Request.responseText)
        for (a=0; a<coords.coordinates.length; a++) {
          flightPathCoordinates.push(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
        }
        flightPath = new google.maps.Polyline({
          path: flightPathCoordinates,
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        })
        flightPath.setMap(map)
      }
    }
    function addPointLoop() {
      console.log('LOOPING');
      Request.onreadystatechange = addPoint;
      Request.open('GET', '{{ url_for('get_coords') }}');
      Request.send();
    }

    function addPoint() {
      if (Request.readyState == 4) {
        var path = flightPath.getPath();
        var coords = JSON.parse(Request.responseText);
        for (a=0; a<coords.coordinates.length; a++) {
          path.push(new google.maps.LatLng(coords.coordinates[a].latitude, coords.coordinates[a].longitude))
        }
      }
    }

    function preloader(){
      document.getElementById("loading").style.display = "none";
      document.getElementById("content").style.display = "block";
    }
  }
  google.maps.event.addDomListener(window, 'load', initialize);
{% endblock %}
{% block body %}
    <div id="map">
      <div id="map-canvas" style="height:300px; width:400px; z:index:-1; margin: 0 auto;"></div>
    </div>
{% endblock %}